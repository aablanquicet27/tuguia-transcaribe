<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>춰Yo te llevo! - Tuguia</title>
    <style>
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            border-radius: 22px;
            box-shadow: 0 8px 32px rgba(107,70,193,0.10);
            padding: 2.5rem 2rem 2rem 2rem;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        .title {
            font-size: 2rem;
            color: #6b46c1;
            font-weight: 700;
            margin-bottom: 1.2rem;
            letter-spacing: 0.5px;
        }
        .subtitle {
            font-size: 1.1rem;
            color: #4a5568;
            margin-bottom: 2.2rem;
            font-weight: 400;
        }
        .big-icon {
            font-size: 3.5rem;
            margin-bottom: 1.2rem;
            color: #ff6600;
        }
        .main-btn {
            background: linear-gradient(135deg, #6b46c1, #553c9a);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 0.9rem 2.2rem;
            box-shadow: 0 6px 20px rgba(107,70,193,0.13);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            letter-spacing: 0.5px;
            margin-top: 1.5rem;
        }
        .main-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 32px rgba(107,70,193,0.18);
        }
        .info-section {
            margin-top: 1.5rem;
            text-align: left;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .info-section ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        .info-section li {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="big-icon">游빐</div>
        <div class="title">춰Yo te llevo!</div>
        <div class="subtitle">쯅o sabes c칩mo llegar a tu destino?<br>D칠jalo en mis manos, te ayudo a encontrar la mejor ruta y te acompa침o en el camino.</div>
        <div id="info-paraderos" class="info-section"></div>
        <div id="info-ruta" class="info-section"></div>
        <a href="tuguia.html">
            <button class="main-btn">Volver a la gu칤a</button>
        </a>
    </div>
    <!-- Mapa de paraderos y estaciones fuera del contenedor principal -->
    <div id="map" style="width:100vw; height:60vh; min-height:300px; margin-top: 2rem;"></div>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@mapbox/polyline"></script>
    <script>
    // Utilidad para calcular distancia entre dos puntos (Haversine)
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000; // Radio de la Tierra en metros
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    // Funci칩n para procesar el nombre del paradero
    function procesarNombreParadero(nombreCompleto) {
      if (!nombreCompleto) return { nombreParadero: 'Sin nombre', ruta: '' };
      
      const match = nombreCompleto.match(/^([A-Z]\d+[A-Z]?)\s+para\s+(.+)$/i);
      if (match) {
        return {
          nombreParadero: match[2].trim(),
          ruta: match[1].trim()
        };
      }
      
      return {
        nombreParadero: nombreCompleto,
        ruta: ''
      };
    }
    // Geocodificaci칩n con timeout
    async function geocodificarDireccion(direccion, timeoutMs = 7000) {
      return Promise.race([
        (async () => {
          try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion + ', Cartagena, Colombia')}&limit=1`);
            const data = await response.json();
            if (data.length > 0) {
              return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
            }
            return null;
          } catch (error) {
            console.error('Error geocodificando:', error);
            return null;
          }
        })(),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Geocodificaci칩n muy lenta o sin respuesta')), timeoutMs))
      ]);
    }
    // Leer puntos de partida y destino
    let start = localStorage.getItem('tuguia_start') || '';
    let end = localStorage.getItem('tuguia_end') || '';
    document.getElementById('info-paraderos').innerHTML = `<b>Procesando informaci칩n...</b><br>Punto de partida: ${start}<br>Punto destino: ${end}`;
    function parseCoords(str) {
      if (!str) return null;
      let match = str.match(/(-?\d+\.\d+),\s*(-?\d+\.\d+)/);
      if (match) return [parseFloat(match[1]), parseFloat(match[2])];
      return null;
    }
    let startCoords = parseCoords(start);
    let endCoords = parseCoords(end);
    async function procesarInformacion() {
      try {
        console.log('Iniciando procesamiento de informaci칩n...');
        console.log('Start:', start, 'End:', end);
        console.log('StartCoords:', startCoords, 'EndCoords:', endCoords);
        
        if (!startCoords && start) {
          document.getElementById('info-paraderos').innerHTML = '<b>Geocodificando punto de partida...</b>';
          try {
            startCoords = await geocodificarDireccion(start);
            console.log('StartCoords geocodificadas:', startCoords);
          } catch (e) {
            console.error('Error geocodificando start:', e);
            document.getElementById('info-paraderos').innerHTML = '<b>No se pudo geocodificar el punto de partida.</b>';
            return;
          }
        }
        if (!endCoords && end) {
          document.getElementById('info-ruta').innerHTML = '<b>Geocodificando punto destino...</b>';
          try {
            endCoords = await geocodificarDireccion(end);
            console.log('EndCoords geocodificadas:', endCoords);
          } catch (e) {
            console.error('Error geocodificando end:', e);
            document.getElementById('info-ruta').innerHTML = '<b>No se pudo geocodificar el punto destino.</b>';
            return;
          }
        }
        
        console.log('Cargando archivo GeoJSON...');
        const response = await fetch('transcaribe_completo_actualizado.geojson');
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        const data = await response.json();
        console.log('Archivo GeoJSON cargado, features:', data.features ? data.features.length : 'undefined');
        
        if (!startCoords) {
          document.getElementById('info-paraderos').innerHTML = '<b>No se pudo obtener las coordenadas del punto de partida.</b><br>Por favor, selecciona un punto en el mapa en tuguia.html o ingresa una direcci칩n v치lida.';
          return;
        }
        
        // Filtrar solo paraderos de Transcaribe (filtro m치s inclusivo)
        console.log('Filtrando paraderos...');
        let paraderos = data.features.filter(f => {
          if (!f || !f.geometry || !f.properties) {
            console.log('Feature inv치lida:', f);
            return false;
          }
          return f.geometry.type === 'Point' && (
            (f.properties.network && f.properties.network.toLowerCase().includes('transcaribe')) ||
            (f.properties.operator && f.properties.operator.toLowerCase().includes('transcaribe')) ||
            (f.properties.highway === 'bus_stop') ||
            (f.properties.public_transport === 'platform') ||
            (f.properties.name && (
              f.properties.name.toLowerCase().includes('transcaribe') ||
              f.properties.name.toLowerCase().includes('portal') ||
              f.properties.name.toLowerCase().includes('estaci칩n') ||
              f.properties.name.toLowerCase().includes('paradero')
            ))
          );
        }).map(f => {
          try {
            return {
              id: f.properties['@id'] || f.id || null,
              nombre: f.properties && f.properties.name ? f.properties.name : 'Sin nombre',
              lat: f.geometry.coordinates[1],
              lon: f.geometry.coordinates[0],
              rutas: Array.isArray(f.properties && f.properties.rutas) ? f.properties.rutas : []
            };
          } catch (error) {
            console.error('Error procesando feature:', f, error);
            return null;
          }
        }).filter(f => f !== null);
        
        console.log('Paraderos filtrados:', paraderos.length);
        let cercanos = paraderos.map(f => {
          let [lon, lat] = [f.lon, f.lat];
          let dist = haversine(startCoords[0], startCoords[1], lat, lon);
          let rutas = Array.isArray(f.rutas) ? f.rutas : [];
          return {nombre: f.nombre, dist, rutas, lat, lon, id: f.id};
        }).filter(p => p.dist < 500).sort((a, b) => a.dist - b.dist);
        let html = '';
        if (cercanos.length === 0) {
          let cercanos1km = paraderos.map(f => {
            let dist = haversine(startCoords[0], startCoords[1], f.lat, f.lon);
            let rutas = Array.isArray(f.rutas) ? f.rutas : [];
            return {nombre: f.nombre, dist, rutas, lat: f.lat, lon: f.lon};
          }).filter(p => p.dist < 1000).sort((a, b) => a.dist - b.dist).slice(0, 3);
          if (cercanos1km.length > 0) {
            html = '<b>No hay paraderos muy cercanos, pero aqu칤 tienes opciones a menos de 1km:</b><ul>' + 
                   cercanos1km.map(p => `<li><b>${p.nombre}</b> (${p.dist.toFixed(0)} m) <br>Rutas: ${(Array.isArray(p.rutas) && p.rutas.length ? p.rutas.join(', ') : 'Sin rutas')}</li>`).join('') + '</ul>';
          } else {
            html = '<b>No hay paraderos de Transcaribe cercanos a tu punto de partida.</b><br>Puedes considerar usar otro medio de transporte.';
          }
        } else {
          html = '<b>Paraderos cercanos a tu punto de partida:</b><ul>' + cercanos.map(p => `<li><b>${p.nombre}</b> (${p.dist.toFixed(0)} m) <br>Rutas: ${(Array.isArray(p.rutas) && p.rutas.length ? p.rutas.join(', ') : 'Sin rutas')}</li>`).join('') + '</ul>';
        }
        document.getElementById('info-paraderos').innerHTML = html;
        if (!endCoords) {
          document.getElementById('info-ruta').innerHTML = '<b>No se pudo obtener las coordenadas del punto destino.</b><br>Por favor, selecciona un destino en el mapa en tuguia.html o ingresa una direcci칩n v치lida.';
          return;
        }
        // Par치metro ajustable para el radio de b칰squeda (en metros)
        let radioBusqueda = 500;

        // Agregar un control para ajustar el radio de b칰squeda
        document.addEventListener('DOMContentLoaded', function() {
          const cont = document.querySelector('.container');
          if (cont && !document.getElementById('radio-busqueda-control')) {
            const div = document.createElement('div');
            div.style = 'margin-bottom:1em;text-align:left;';
            div.innerHTML = `
              <label for="radio-busqueda" style="font-weight:600;color:#6b46c1;">Radio de b칰squeda de paraderos (m): </label>
              <input type="number" id="radio-busqueda" min="100" max="2000" step="50" value="500" style="width:80px;">
              <button id="aplicar-radio" style="margin-left:8px;">Aplicar</button>
            `;
            div.id = 'radio-busqueda-control';
            cont.insertBefore(div, cont.children[3]);
            document.getElementById('aplicar-radio').onclick = function() {
              let val = parseInt(document.getElementById('radio-busqueda').value);
              if (!isNaN(val) && val > 0) {
                radioBusqueda = val;
                procesarInformacion();
              }
            };
          }
        });
        // Buscar los paraderos dentro del radio ajustable
        let paraderosCandidatos = paraderos.map(f => {
          let dist = haversine(endCoords[0], endCoords[1], f.lat, f.lon);
          let rutas = Array.isArray(f.rutas) ? f.rutas : [];
          let nombreInfo = procesarNombreParadero(f.nombre);
          if (rutas.length === 0 && nombreInfo.ruta) {
            rutas = [nombreInfo.ruta];
          }
          return {
            nombre: nombreInfo.nombreParadero,
            ruta: nombreInfo.ruta,
            dist,
            rutas,
            lat: f.lat,
            lon: f.lon,
            id: f.id
          };
        }).sort((a, b) => a.dist - b.dist);
        let paraderosDestino = paraderosCandidatos.filter(p => p.dist < radioBusqueda).slice(0, 3);
        // Si no hay paraderos dentro del radio, mostrar los 3 m치s cercanos aunque est칠n m치s lejos
        if (paraderosDestino.length === 0 && paraderosCandidatos.length > 0) {
          paraderosDestino = paraderosCandidatos.slice(0, 3);
        }
        // Mostrar lista de los 3 m치s cercanos con distancia a pie si es posible
        let paraderosHtml = '<b><span style="color:#006400">Paraderos m치s cercanos a tu destino:</span></b><ul id="lista-paraderos-destino"></ul>';
        document.getElementById('info-ruta').innerHTML = paraderosHtml;
        if (paraderosDestino.length === 0) {
          document.getElementById('lista-paraderos-destino').innerHTML = '<li>No hay paraderos de Transcaribe cercanos a tu destino. Prueba ampliando el radio de b칰squeda o selecciona otro destino.</li>';
        } else {
          paraderosDestino.forEach((p, idx) => {
            let liId = `paradero-destino-${idx}`;
            let rutasTxt = (Array.isArray(p.rutas) && p.rutas.length ? p.rutas.join(', ') : 'Sin rutas');
            let liStyle = idx === 0 ? 'background:#e6ffe6;border-left:5px solid #1ca12d;padding:0.5em 0.5em 0.5em 1em;margin-bottom:0.5em;' : '';
            let nombreParadero = p.nombre;
            if (p.ruta) {
              nombreParadero = `<b>${p.ruta}</b> - ${p.nombre}`;
            }
            document.getElementById('lista-paraderos-destino').innerHTML += `<li id="${liId}" style="${liStyle}">${nombreParadero} (calculando...)<br>Rutas: ${rutasTxt}</li>`;
            obtenerDistanciaCaminando(endCoords, [p.lat, p.lon]).then(distanciaCaminando => {
              let texto = '';
              if (distanciaCaminando) {
                texto = `${Math.round(distanciaCaminando)} m (a pie)`;
              } else {
                texto = `${p.dist.toFixed(0)} m (l칤nea recta)`;
              }
              document.getElementById(liId).innerHTML = `${nombreParadero} (${texto})<br>Rutas: ${rutasTxt}`;
            });
          });
        }
      } catch (error) {
        console.error('Error procesando informaci칩n:', error);
        document.getElementById('info-paraderos').innerHTML = '<b>Error procesando la informaci칩n:</b> ' + error.message;
      }
    }
    procesarInformacion();
    </script>
    <!-- Bot칩n oculto para actualizar el mapa (solo admin) -->
    <button id="actualizar-mapa-btn" style="display:none;position:fixed;bottom:24px;right:24px;z-index:9999;background:#007bff;color:#fff;border:none;border-radius:12px;padding:1rem 2rem;font-size:1.1rem;font-weight:600;box-shadow:0 6px 20px rgba(107,70,193,0.13);cursor:pointer;">Actualizar Mapa</button>
    <script>
    // Mostrar el bot칩n solo si se ingresa la clave secreta tras Ctrl+Alt+M
    window.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'm') {
        const clave = prompt('Clave de administrador:');
        if (clave === 'transcaribe2024') {
          document.getElementById('actualizar-mapa-btn').style.display = 'block';
          alert('Bot칩n de actualizaci칩n activado.');
        } else {
          alert('Clave incorrecta.');
        }
      }
    });
    document.getElementById('actualizar-mapa-btn').onclick = async function() {
      if (!confirm('쮻eseas actualizar el archivo de paraderos y estaciones de Transcaribe?')) return;
      const bbox = '10.35,-75.56,10.48,-75.44'; // Limites de Cartagena
      const query = `
        [out:json][timeout:25];
        (
          node["network"~"Transcaribe|TransCaribe|TracsCaribe",i](${bbox});
          node["operator"~"Transcaribe",i](${bbox});
          node["name"~"Transcaribe|Portal|Estaci칩n|Auxiliadora|Bodeguita|Castellana|Bernarda|Bazurto|Popa|Prado|Espa침a|Cuatro Vientos|Ol칤mpica|Ejecutivos|Crespo|Socorro|Mandela|Bosque|Consulado|Romero|Campanos|Junio|Lezo|Campo|Pozon|Estrella|Manga|Torices|Terminal",i](${bbox});
          node["highway"="bus_stop"](${bbox});
          node["public_transport"="platform"](${bbox});
        );
        out body;
        >;
        out skel qt;
      `;
      try {
        const res = await fetch('https://overpass-api.de/api/interpreter', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'data=' + encodeURIComponent(query)
        });
        const data = await res.json();
        const features = data.elements
          .filter(e => e.type === 'node' && e.lat && e.lon)
          .map(e => ({
            type: 'Feature',
            properties: {
              ...e.tags,
              '@id': e.id
            },
            geometry: {
              type: 'Point',
              coordinates: [e.lon, e.lat]
            },
            id: e.id
          }));
        const geojson = {
          type: 'FeatureCollection',
          generator: 'Transcaribe Complete Data',
          copyright: 'The data included in this document is from www.openstreetmap.org. The data is made available under ODbL.',
          timestamp: new Date().toISOString(),
          features
        };
        const blob = new Blob([JSON.stringify(geojson, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'transcaribe_completo_actualizado.geojson';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('춰Archivo GeoJSON generado y descargado! Recuerda subirlo a tu servidor o carpeta public.');
      } catch (err) {
        alert('Error al generar el archivo: ' + err.message);
      }
    };
    </script>
    <script>
    // Inicializaci칩n b치sica del mapa y marcadores (igual que yotellevo_ok.html)
    let map = L.map('map').setView([10.42312, -75.54802], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '춸 OpenStreetMap contributors'
    }).addTo(map);
    // Cargar paraderos y estaciones desde Overpass (igual que yotellevo_ok.html)
    const OVERPASS_URL = 'https://overpass-api.de/api/interpreter';
    const CARTAGENA_BOUNDS = [10.35, -75.56, 10.48, -75.44];
    let estaciones = [], paraderos = [], paraderosLayerGroup = L.layerGroup().addTo(map);
    async function cargarEstacionesYParaderos() {
      const bbox = CARTAGENA_BOUNDS.join(',');
      const query = `[out:json][timeout:25];\n(\n  node[\"network\"~\"Transcaribe\",i](${bbox});\n  node[\"operator\"~\"Transcaribe\",i](${bbox});\n  node[\"name\"~\"Transcaribe|Portal|Estaci칩n|Auxiliadora|Bodeguita|Castellana|Bernarda|Bazurto|Popa|Prado|Espa침a|Cuatro Vientos|Ol칤mpica|Ejecutivos|Crespo|Socorro|Mandela|Bosque|Consulado|Romero|Campanos|Junio|Lezo|Campo|Pozon|Estrella|Manga|Torices|Terminal\",i](${bbox});\n  node[\"highway\"=\"bus_stop\"](${bbox});\n  node[\"public_transport\"=\"platform\"](${bbox});\n  way[\"network\"~\"Transcaribe\",i](${bbox});\n  way[\"operator\"~\"Transcaribe\",i](${bbox});\n  way[\"name\"~\"Transcaribe|Portal|Estaci칩n|Auxiliadora|Bodeguita|Castellana|Bernarda|Bazurto|Popa|Prado|Espa침a|Cuatro Vientos|Ol칤mpica|Ejecutivos|Crespo|Socorro|Mandela|Bosque|Consulado|Romero|Campanos|Junio|Lezo|Campo|Pozon|Estrella|Manga|Torices|Terminal\",i](${bbox});\n  way[\"highway\"=\"bus_stop\"](${bbox});\n  way[\"public_transport\"=\"platform\"](${bbox});\n  relation[\"network\"~\"Transcaribe\",i](${bbox});\n  relation[\"operator\"~\"Transcaribe\",i](${bbox});\n  relation[\"name\"~\"Transcaribe|Portal|Estaci칩n|Auxiliadora|Bodeguita|Castellana|Bernarda|Bazurto|Popa|Prado|Espa침a|Cuatro Vientos|Ol칤mpica|Ejecutivos|Crespo|Socorro|Mandela|Bosque|Consulado|Romero|Campanos|Junio|Lezo|Campo|Pozon|Estrella|Manga|Torices|Terminal\",i](${bbox});\n  relation[\"highway\"=\"bus_stop\"](${bbox});\n  relation[\"public_transport\"=\"platform\"](${bbox});\n);\nout center;`;
      const response = await fetch(OVERPASS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'data=' + encodeURIComponent(query)
      });
      const data = await response.json();
      const elementos = data.elements.map(e => {
        if (e.type === 'node') {
          return { ...e, lat: e.lat, lon: e.lon };
        } else if ((e.type === 'way' || e.type === 'relation') && e.center) {
          return { ...e, lat: e.center.lat, lon: e.center.lon };
        }
        return null;
      }).filter(e => e && e.lat && e.lon);
      estaciones = elementos.filter(e => e.tags && (
        e.tags.network === 'Transcaribe' ||
        e.tags.operator === 'Transcaribe S.A.' ||
        (e.tags.name && (e.tags.name.includes('Portal') || e.tags.name.includes('Estaci칩n')))
      ));
      paraderos = elementos.filter(e => e.tags && (
        e.tags.highway === 'bus_stop' ||
        e.tags.public_transport === 'platform'
      ));
      mostrarEstacionesYParaderosEnMapa();
    }
    function mostrarEstacionesYParaderosEnMapa() {
      paraderosLayerGroup.clearLayers();
      estaciones.forEach(est => {
        const marker = L.marker([est.lat, est.lon], {
          icon: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/252/252025.png',
            iconSize: [24, 24], iconAnchor: [12, 24]
          })
        }).on('click', () => L.popup().setLatLng([est.lat, est.lon]).setContent(`<b>${est.tags.name || 'Estaci칩n'}</b><br>Red: ${est.tags.network || est.tags.operator || 'Transcaribe'}`).openOn(map));
        paraderosLayerGroup.addLayer(marker);
      });
      paraderos.forEach(stop => {
        const marker = L.marker([stop.lat, stop.lon], {
          icon: L.icon({
            iconUrl: 'BUS.jpeg',
            iconSize: [32, 32], iconAnchor: [16, 32]
          })
        }).on('click', () => L.popup().setLatLng([stop.lat, stop.lon]).setContent(`<b>${stop.tags.name || 'Paradero'}</b><br>Tipo: Paradero<br>Red: ${stop.tags.network || 'Transcaribe'}`).openOn(map));
        paraderosLayerGroup.addLayer(marker);
      });
    }
    cargarEstacionesYParaderos();
    </script>
    <script>
    // Funci칩n para obtener la distancia caminando usando OpenRouteService
    async function obtenerDistanciaCaminando(origen, destino) {
      const apiKey = '5b3ce3597851110001cf6248e92a24fdb4744773ab33cab2c808de44';
      const url = `https://api.openrouteservice.org/v2/directions/foot-walking?api_key=${apiKey}`;
      const body = {
        coordinates: [
          [origen[1], origen[0]], // [lon, lat]
          [destino[1], destino[0]]
        ]
      };
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await response.json();
        if (data && data.features && data.features[0]) {
          return data.features[0].properties.summary.distance; // en metros
        }
        return null;
      } catch (e) {
        console.error('Error consultando ORS:', e);
        return null;
      }
    }
    </script>
    <!-- Bot칩n para mostrar todos los paraderos en el mapa -->
    <button id="ver-todos-paraderos-btn" style="display:none;position:fixed;bottom:24px;right:24px;z-index:9999;background:#007bff;color:#fff;border:none;border-radius:12px;padding:1rem 2rem;font-size:1.1rem;font-weight:600;box-shadow:0 6px 20px rgba(107,70,193,0.13);cursor:pointer;">Ver todos los paraderos en el mapa</button>
    <script>
    // Mostrar el bot칩n solo si se ingresa la clave secreta tras Ctrl+Alt+M
    window.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'm') {
        const clave = prompt('Clave de administrador:');
        if (clave === 'transcaribe2024') {
          document.getElementById('ver-todos-paraderos-btn').style.display = 'block';
          alert('Bot칩n de actualizaci칩n activado.');
        } else {
          alert('Clave incorrecta.');
        }
      }
    });
    document.getElementById('ver-todos-paraderos-btn').onclick = function() {
      map.setView([10.42312, -75.54802], 13);
      paraderosLayerGroup.clearLayers();
      paraderos.forEach(stop => {
        const marker = L.marker([stop.lat, stop.lon], {
          icon: L.icon({
            iconUrl: 'BUS.jpeg',
            iconSize: [32, 32], iconAnchor: [16, 32]
          })
        }).on('click', () => L.popup().setLatLng([stop.lat, stop.lon]).setContent(`<b>${stop.nombre || 'Paradero'}</b><br>Tipo: Paradero<br>Red: Transcaribe`).openOn(map));
        paraderosLayerGroup.addLayer(marker);
      });
    };
    </script>
</body>
</html> 